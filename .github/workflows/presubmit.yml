name: Presubmit

on:
  pull_request:
  push:
    branches:
      - master

jobs:
  canonical-api-surface-lint:
    name: Canonical API Surface Lint
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Rewrite GitHub SSH URLs
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:
          git config --global url."https://github.com/".insteadOf ssh://git@github.com/

      - name: Lint Canonical API Surface
        run: ./scripts/lint_canonical_api_surface.sh

  architecture-size-guardrails:
    name: Architecture Size Guardrails
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Rewrite GitHub SSH URLs
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:
          git config --global url."https://github.com/".insteadOf ssh://git@github.com/

      - name: Lint Architecture Size
        run: ./scripts/lint_architecture_size.sh

  build-matrix:
    name: Build/Test (${{ matrix.build_type }})
    runs-on: macos-14
    strategy:
      fail-fast: true
      matrix:
        build_type:
          - relwithdebinfo
          - release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Rewrite GitHub SSH URLs
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:
          git config --global url."https://github.com/".insteadOf ssh://git@github.com/

      - name: Build
        run: ./scripts/compile.sh --${{ matrix.build_type }}

      - name: Fail Fast On Focus/Interaction Regressions
        run: |
          build_dir="build-${{ matrix.build_type }}"
          "${build_dir}/PrimeStage_tests" --test-case="*focus*,*interaction*,*ergonomics*"

      - name: Full Test Pass
        run: ./scripts/compile.sh --${{ matrix.build_type }} --test

      - name: Performance Budget Gate
        if: matrix.build_type == 'release'
        run: |
          ./build-release/PrimeStage_benchmarks \
            --budget-file tests/perf/perf_budgets.txt \
            --check-budgets \
            --output build-release/perf-results.json

  toolchain-quality:
    name: Toolchain Quality Gates
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Rewrite GitHub SSH URLs
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:
          git config --global url."https://github.com/".insteadOf ssh://git@github.com/

      - name: Warning Gate (Project Targets)
        run: ./scripts/compile.sh --debug --warnings-as-errors

      - name: Sanitizer Gate (ASan/UBSan Tests)
        env:
          ASAN_OPTIONS: detect_leaks=0
        run: ./scripts/compile.sh --debug --asan --ubsan --test

  headless-compatibility:
    name: Headless Compatibility
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Rewrite GitHub SSH URLs
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:
          git config --global url."https://github.com/".insteadOf ssh://git@github.com/

      - name: Configure Headless Compatibility Build
        run: |
          cmake -S . -B build-headless-compat \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_OBJCXX_COMPILER=clang++ \
            -DPRIMESTAGE_BUILD_TESTS=ON \
            -DPRIMESTAGE_BUILD_EXAMPLES=OFF \
            -DPRIMESTAGE_HEADLESS_ONLY=ON \
            -DPRIMESTAGE_ENABLE_PRIMEMANIFEST=OFF \
            -DPRIMESTAGE_FETCH_PRIMEHOST=ON

      - name: Build Headless Compatibility
        run: cmake --build build-headless-compat

      - name: Focus/Interaction Smoke
        run: ./build-headless-compat/PrimeStage_tests --test-case="*focus*,*interaction*,*ergonomics*"

      - name: Full Headless Test Pass
        run: ctest --test-dir build-headless-compat --output-on-failure
